<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã•ãã‚‰ã‚¢ãƒªã®ç´æœŸç®¡ç†ãƒ„ãƒ¼ãƒ«</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{font-family:'M PLUS Rounded 1c', sans-serif;background:#ffeef4;margin:0;padding:20px;}
.container{max-width:1100px;margin:auto;background:white;padding:20px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
h1{text-align:center;color:#ff6fa5;font-weight:700;}
.note{background:#fff4f8;padding:12px;border-radius:10px;font-size:14px;margin-bottom:15px;line-height:1.7;}
.controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px;}
input,button{padding:8px 10px;border-radius:10px;border:1px solid #ddd;font-family:'M PLUS Rounded 1c', sans-serif;}
button{background:#ff8fb5;color:white;border:none;cursor:pointer;font-weight:700;}
button:hover{opacity:0.85;}

#addBtn{background:#ff5c9e;font-size:15px;}

#privacyBtn{background:white;color:#333;border:2px solid #333;}
#privacyBtn.active{background:#111;color:white;border-color:#111;}

#rankingToggleBtn.off{background:#ccc;color:#333;}

#editNotice{
display:none;
background:#fff3cd;
color:#b35c00;
padding:12px;
border-radius:12px;
font-weight:700;
text-align:center;
margin-bottom:12px;
box-shadow:0 3px 8px rgba(0,0,0,0.08);
border:2px solid #ffd76a;
}

/* ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã ã‘è»½ãå¼·èª¿ */
.register-box{
background:#fff6fa;
padding:15px;
border-radius:15px;
margin-bottom:15px;
}

.register-title{
font-weight:700;
color:#ff4f93;
margin-bottom:8px;
text-align:center;
}

.table-top{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
.left-group{font-size:14px;}
.right-group button{font-size:12px;margin-left:5px;}

table{width:100%;border-collapse:collapse;margin-bottom:10px;}
th,td{padding:8px;text-align:center;border-bottom:1px solid #eee;font-size:14px;}
th{background:#ffb6d0;font-weight:700;}
tr.danger{background:#ffd6d6;}

.hide{display:none;}

.done-section{background:#fff8d9;padding:10px;border-radius:10px;margin-top:15px;}

.ranking-section{background:#e8f9ff;padding:12px;border-radius:12px;margin-top:10px;}
.ranking-item{padding:5px 0;border-bottom:1px dashed #ccc;font-size:14px;}

.center{text-align:center;margin-top:10px;}
</style>
</head>
<body>

<div class="container">
<h1>ğŸŒ¸ã•ãã‚‰ã‚¢ãƒªã®ç´æœŸç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>

<div class="note">
<b>â–  ä½¿ã„æ–¹</b><br>
ç™»éŒ²ã™ã‚‹ã¨ä¾é ¼ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç·¨é›†ãƒ»å‰Šé™¤å¯èƒ½ã€‚<br>
ç´æœŸãŒè¿‘ã„ã¨è‰²ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚<br><br>
<b>â–  æ¸ˆãƒœã‚¿ãƒ³</b>ï¼šå®Œäº†ãƒªã‚¹ãƒˆã¸ç§»å‹•ã—ã¾ã™ã€‚<br>
<b>â–  ç·¨é›†ã—ã¦å†ä¾é ¼</b>ï¼šãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã•ã‚Œã€å†ç·¨é›†ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚<br>
<b>â–  ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ‰</b>ï¼šåå‰ã¨URLã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã€‚<br>
<b>â–  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</b>ï¼šãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ã®ãŸã‚å®šæœŸä¿å­˜æ¨å¥¨ã€‚
</div>

<div class="controls">
<button id="privacyBtn" onclick="togglePrivacy()">ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ‰</button>
<button onclick="saveImage()">ğŸ“¸ ä¸€è¦§ç”»åƒä¿å­˜</button>
<button onclick="backupData()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
<input type="file" onchange="restoreData(event)">
</div>

<div id="editNotice">ğŸ”„ å†ä¾é ¼ãƒ¢ãƒ¼ãƒ‰ï¼šå†ç·¨é›†ã—ã¦ç™»éŒ²ã§ãã¾ã™</div>

<div class="register-box">
<div class="register-title">ğŸ“ æ–°è¦ç™»éŒ²</div>
<div class="controls">
<input type="text" id="taskName" placeholder="åå‰">
<input type="text" id="content" placeholder="å†…å®¹">
<input type="date" id="deadline">
<input type="url" id="url" placeholder="URL(ä»»æ„)">
<button onclick="addTask()" id="addBtn">ç™»éŒ²</button>
</div>
</div>

<p>ğŸ“‹ ä¾é ¼ä¸€è¦§ï¼ˆ<span id="taskCount">0</span>ä»¶ï¼‰</p>

<div class="table-top">
<div class="left-group">
ğŸ¨ è‰²å¤‰æ›´æ—¥æ•°ï¼š
<input type="number" id="dangerDays" value="3" min="0" style="width:60px;"> æ—¥ä»¥å†…
</div>
<div class="right-group">
<button onclick="sortByDeadline()">ç´æœŸãŒè¿‘ã„é †</button>
<button onclick="sortByCreated()">ç™»éŒ²é †</button>
</div>
</div>

<table id="taskTable">
<thead>
<tr>
<th>ç™»éŒ²æ—¥</th>
<th>ç´æœŸ</th>
<th>æ®‹ã‚Šæ—¥æ•°</th>
<th class="nameCol">åå‰</th>
<th>å†…å®¹</th>
<th class="urlCol">URL</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="taskList"></tbody>
</table>

<p>ğŸ” æ¤œç´¢: <input type="text" id="searchInput"></p>

<div class="done-section">
<h3>âœ… æ¸ˆä¸€è¦§ï¼ˆ<span id="doneCount">0</span>ä»¶ï¼‰</h3>
<table>
<thead>
<tr>
<th>ç™»éŒ²æ—¥</th>
<th class="nameCol">åå‰</th>
<th>å†…å®¹</th>
<th class="urlCol">URL</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="doneList"></tbody>
</table>
</div>

<div class="center">
<button id="rankingToggleBtn" onclick="toggleRankingView()">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ON</button>
</div>

<div id="rankingWrapper" class="ranking-section">
<h3>å•†å“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå…ˆé ­4æ–‡å­—ä¸€è‡´ï¼‰</h3>
<div id="rankingList"></div>
</div>

</div>

<script>
/* JSã¯å®Œå…¨ä¿æŒï¼ˆå‰å›ã¨åŒã˜ï¼‰ */
let tasks=JSON.parse(localStorage.getItem("tasks")||"[]");
let privacy=false;
let rankingVisible=true;
let editModeId=null;

const nameInput=document.getElementById("taskName");
const contentInput=document.getElementById("content");
const deadlineInput=document.getElementById("deadline");
const urlInput=document.getElementById("url");
const taskListEl=document.getElementById("taskList");
const doneListEl=document.getElementById("doneList");
const dangerInput=document.getElementById("dangerDays");
const searchInput=document.getElementById("searchInput");
const taskCountEl=document.getElementById("taskCount");
const doneCountEl=document.getElementById("doneCount");
const privacyBtn=document.getElementById("privacyBtn");
const rankingEl=document.getElementById("rankingList");
const rankingWrapper=document.getElementById("rankingWrapper");
const rankingToggleBtn=document.getElementById("rankingToggleBtn");
const editNotice=document.getElementById("editNotice");
const addBtn=document.getElementById("addBtn");

deadlineInput.valueAsDate=new Date();
function todayStr(){return new Date().toISOString().split("T")[0];}
function save(){localStorage.setItem("tasks",JSON.stringify(tasks));}

function addTask(){
if(!nameInput.value.trim()||!deadlineInput.value){alert("åå‰ã¨ç´æœŸã¯å¿…é ˆï¼");return;}
if(editModeId){
tasks=tasks.filter(t=>t.id!==editModeId);
editModeId=null;
editNotice.style.display="none";
addBtn.textContent="ç™»éŒ²";
}
tasks.unshift({id:Date.now(),name:nameInput.value,content:contentInput.value,deadline:deadlineInput.value,url:urlInput.value,created:todayStr(),done:false});
nameInput.value=contentInput.value=urlInput.value="";
deadlineInput.valueAsDate=new Date();
save();render();
}

function editDoneTask(id){
const t=tasks.find(x=>x.id===id);
if(!t)return;
nameInput.value=t.name;
contentInput.value=t.content;
deadlineInput.value=t.deadline;
urlInput.value=t.url;
editModeId=id;
editNotice.style.display="block";
addBtn.textContent="å†ç™»éŒ²";
window.scrollTo({top:0,behavior:"smooth"});
}

function markDone(id){tasks.find(t=>t.id===id).done=true;save();render();}
function deleteTask(id){tasks=tasks.filter(t=>t.id!==id);save();render();}
function duplicateTask(id){const t=tasks.find(x=>x.id===id);tasks.push({...t,id:Date.now(),done:false});save();render();}


function editTask(id){
const t=tasks.find(x=>x.id===id);
if(!t)return;

nameInput.value=t.name;
contentInput.value=t.content;
deadlineInput.value=t.deadline;
urlInput.value=t.url;

editModeId=id;
editNotice.style.display="block";
addBtn.textContent="å†ç™»éŒ²";

window.scrollTo({top:0,behavior:"smooth"});
}

function toggleRankingView(){
rankingVisible=!rankingVisible;
rankingWrapper.style.display=rankingVisible?"block":"none";
rankingToggleBtn.textContent="ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º "+(rankingVisible?"ON":"OFF");
rankingToggleBtn.classList.toggle("off",!rankingVisible);
}

function generateRanking(){
let map={};
tasks.forEach(t=>{
if(!t.content||t.content.length<4)return;
let key=t.content.substring(0,4);
if(!map[key])map[key]={request:0,done:0};
if(t.done)map[key].done++;else map[key].request++;
});
let arr=Object.entries(map).sort((a,b)=>(b[1].request+b[1].done)-(a[1].request+a[1].done));
rankingEl.innerHTML="";
arr.forEach((r,i)=>{
rankingEl.innerHTML+=`<div class="ranking-item">${i+1}ä½ï¼š${r[0]}ï¼ˆä¾é ¼${r[1].request}ä»¶ãƒ»æ¸ˆ${r[1].done}ä»¶ï¼‰</div>`;
});
}

function daysLeft(date){return Math.ceil((new Date(date)-new Date())/(1000*60*60*24));}

function render(){
taskListEl.innerHTML="";doneListEl.innerHTML="";
const danger=parseInt(dangerInput.value)||0;
const keyword=searchInput.value.toLowerCase();

tasks.forEach(t=>{
if(!t.name.toLowerCase().includes(keyword)&&!t.content.toLowerCase().includes(keyword))return;
if(t.done){
doneListEl.innerHTML+=`<tr>
<td>${t.created}</td>
<td class="nameCol">${t.name}</td>
<td>${t.content}</td>
<td class="urlCol">${t.url?`<a href="${t.url}" target="_blank">é–‹ã</a>`:""}</td>
<td>
<button onclick="editDoneTask(${t.id})">ç·¨é›†ã—ã¦å†ä¾é ¼</button>
<button onclick="deleteTask(${t.id})">å‰Šé™¤</button>
</td></tr>`;
}else{
const left=daysLeft(t.deadline);
taskListEl.innerHTML+=`<tr class="${left<=danger?"danger":""}">
<td>${t.created}</td>
<td>${t.deadline}</td>
<td>${left}</td>
<td class="nameCol">${t.name}</td>
<td>${t.content}</td>
<td class="urlCol">${t.url?`<a href="${t.url}" target="_blank">é–‹ã</a>`:""}</td>
<td>
<button onclick="editTask(${t.id})">ç·¨é›†</button>
<button onclick="duplicateTask(${t.id})">è¤‡è£½</button>
<button onclick="deleteTask(${t.id})">å‰Šé™¤</button>
<button onclick="markDone(${t.id})">æ¸ˆ</button>
</td></tr>`;
}
});

document.querySelectorAll(".nameCol").forEach(e=>e.classList.toggle("hide",privacy));
document.querySelectorAll(".urlCol").forEach(e=>e.classList.toggle("hide",privacy));
privacyBtn.classList.toggle("active",privacy);
taskCountEl.textContent=taskListEl.children.length;
doneCountEl.textContent=doneListEl.children.length;

if(rankingVisible)generateRanking();
}

searchInput.addEventListener("input",render);
dangerInput.addEventListener("input",render);
function togglePrivacy(){privacy=!privacy;render();}
function sortByDeadline(){tasks.sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));render();}
function sortByCreated(){tasks.sort((a,b)=>a.id-b.id);render();}
function backupData(){const blob=new Blob([JSON.stringify(tasks)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="backup.json";a.click();}
function restoreData(e){const r=new FileReader();r.onload=()=>{tasks=JSON.parse(r.result);save();render();};r.readAsText(e.target.files[0]);}
function saveImage(){html2canvas(document.getElementById("taskTable")).then(c=>{const a=document.createElement("a");a.href=c.toDataURL();a.download="task_list.png";a.click();});}

render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ¸ åŠ¹æœéŸ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ğŸŒ¸</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fff0f5;
      text-align: center;
      padding: 20px;
      margin: 0;
      position: relative;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1 { color: #e91e63; margin-bottom: 40px; }

    #pageNav {
      display: flex; justify-content: center; align-items: center;
      gap: 40px; margin-bottom: 10px;
    }

    #pageNav button {
      background-color: #fff; border: 2px solid #e91e63;
      border-radius: 10px; color: #e91e63; font-weight: bold;
      width: 60px; height: 35px; cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    #pageNav button:hover:not(:disabled){ background-color:#e91e63; color:#fff; }
    #pageNav button:disabled{ opacity:0.4; cursor:default; }

    #pageIndicator{ color:#e91e63; font-weight:bold; font-size:16px; min-width:50px; }

    #buttonGrid {
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:20px; justify-content:center; max-width:600px;
      margin:0 auto 100px; transition:transform 0.3s ease;
      transform-origin:center top;
    }

    .btn-wrap{ display:flex; flex-direction:column; align-items:center; }
    .sound-button{
      background-color:#ffccdd; border:none; border-radius:15px;
      width:180px; height:120px; font-size:18px; cursor:pointer;
      white-space:pre-line; display:flex; align-items:center;
      justify-content:center; text-align:center;
      transition:background-color 0.3s, transform 0.2s;
    }
    .sound-button:hover{ background-color:#ff99bb; }

    .remove-btn{
      background:none; border:none; color:red; font-size:20px;
      cursor:pointer; margin-top:5px; display:none;
    }

    #editPanel{
      width:260px; background:#fff0f5; border:2px solid #e91e63;
      border-radius:15px; padding:15px;
      box-shadow:0 4px 8px rgba(233,30,99,0.3);
      font-size:14px; margin:0 auto; display:none; user-select:none;
    }

    #editPanel h2{ margin-top:0; color:#e91e63; font-size:18px; }
    #editPanel label{ display:block; margin-top:10px; text-align:left; font-weight:bold; }
    #editPanel input[type="text"],
    #editPanel input[type="color"],
    #editPanel input[type="file"],
    #editPanel input[type="range"]{
      width:100%; margin-top:5px; box-sizing:border-box;
      border-radius:5px; border:1px solid #ccc; padding:5px; font-size:14px;
    }

    #editPanel .volume-control{ display:flex; align-items:center; gap:10px; margin-top:5px; }

    #editPanel button{
      padding:4px 10px; font-size:16px; cursor:pointer;
      border-radius:6px; border:none; background-color:#e91e63; color:white;
      transition:background-color 0.3s;
    }
    #editPanel button:hover{ background-color:#c2185b; }

    .bottomControl{
      display:none; flex-direction:column; align-items:center;
      gap:10px; margin-top:20px;
    }

    .bottomControl button{
      background-color:#e91e63; color:white; border:none;
      border-radius:15px; width:180px; height:40px;
      font-weight:bold; font-size:14px; cursor:pointer;
      box-shadow:0 4px 8px rgba(233,30,99,0.4);
      transition:background-color 0.3s;
    }
    .bottomControl button:hover{ background-color:#c2185b; }

    #sizeControlContainer{
      background-color:#e75480; border-radius:12px;
      box-shadow:0 4px 8px rgba(233,30,99,0.3);
      padding:10px; text-align:center;
    }
    #sizeLabel{ display:block; font-size:13px; margin-bottom:5px; color:#fff; }
    #sizeSlider{ width:120px; }

    #noSelectionMsg{ color:#e91e63; font-size:13px; margin-top:10px; }

    #closeControls{ background-color:#888; }
    #closeControls:hover{ background-color:#666; }

    #editToggleContainer{
      position:fixed; top:20px; right:20px;
      z-index:10000; display:flex; flex-direction:column;
      align-items:center; gap:8px;
    }

    #editToggleBtn{
      background-color:#e91e63; color:white; border:none;
      border-radius:15px; width:120px; height:40px;
      font-weight:bold; cursor:pointer;
      box-shadow:0 4px 8px rgba(233,30,99,0.4);
    }
  </style>
</head>
<body>

  <div id="pageNav">
    <button id="prevPage">â†</button>
    <span id="pageIndicator">1</span>
    <button id="nextPage">â†’</button>
  </div>

  <h1>ğŸŒ¸ã•ãã‚‰ã‚¢ãƒªã®åŠ¹æœéŸ³ãƒ„ãƒ¼ãƒ«ğŸŒ¸</h1>
  <div id="buttonGrid"></div>

  <div id="editToggleContainer">
    <button id="editToggleBtn">ç·¨é›†</button>
  </div>

  <div id="editPanel">
    <h2>ç·¨é›†ãƒ‘ãƒãƒ«</h2>
    <div id="noSelectionMsg">ç·¨é›†ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <label for="editLabel">ãƒœã‚¿ãƒ³å</label>
    <input type="text" id="editLabel" placeholder="åå‰ã‚’å…¥åŠ›" disabled />
    <label for="editColor">è‰²ã‚’å¤‰æ›´</label>
    <input type="color" id="editColor" disabled />
    <label for="editFile">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«</label>
    <input type="file" id="editFile" accept="audio/*" disabled />
    <label for="editVolume">éŸ³é‡</label>
    <div class="volume-control">
      <button id="volDown" disabled>âˆ’</button>
      <input type="range" id="editVolume" min="0" max="1" step="0.01" value="1" disabled />
      <button id="volUp" disabled>ï¼‹</button>
    </div>
  </div>

  <div class="bottomControl" id="controlGroup">
    <button id="addButton">ï¼‹ ãƒœã‚¿ãƒ³è¿½åŠ </button>
    <div id="sizeControlContainer">
      <label id="sizeLabel">ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´</label>
      <input type="range" id="sizeSlider" min="50" max="150" value="100" />
    </div>
    <button id="saveButton">ğŸ’¾ ä¿å­˜</button>
    <button id="resetButton">ğŸ”„ åˆæœŸåŒ–</button>
    <button id="backupButton">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <button id="restoreButton">ğŸ“¥ å¾©å…ƒ</button>
    <button id="repostButton">ğŸ” ãƒªãƒã‚¹ãƒˆ</button>
    <button id="closeControls">âœ– é–‰ã˜ã‚‹</button>
  </div>

  <script>
    // ---------- state ----------
    let currentPage = parseInt(localStorage.getItem('currentPage')) || 1;
    let soundData = loadPageData(currentPage);
    let buttonScale = parseInt(localStorage.getItem('buttonScale')) || 100;

    // ---------- IndexedDB åˆæœŸåŒ– & ãƒ˜ãƒ«ãƒ‘ ----------
    let db = null;
    let dbReadyResolve;
    const dbReadyPromise = new Promise((res) => { dbReadyResolve = res; });

    const openReq = indexedDB.open("SakuraSoundDB", 1);
    openReq.onupgradeneeded = function(e) {
      db = e.target.result;
      if (!db.objectStoreNames.contains("sounds")) {
        db.createObjectStore("sounds");
      }
    };
    openReq.onsuccess = function(e) {
      db = e.target.result;
      dbReadyResolve();
    };
    openReq.onerror = function() {
      console.error("IndexedDB error", openReq.error);
      alert("IndexedDB ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚éŸ³å£°ã®ä¿å­˜ãƒ»å¾©å…ƒã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      dbReadyResolve(); // resolve anyway so app doesn't hang
    };

    function putToDB(key, blob) {
      return new Promise((resolve, reject) => {
        try {
          const tx = db.transaction("sounds", "readwrite");
          const store = tx.objectStore("sounds");
          const req = store.put(blob, key);
          req.onsuccess = () => resolve();
          req.onerror = (e) => reject(e);
        } catch (err) {
          reject(err);
        }
      });
    }
    function getFromDB(key) {
      return new Promise((resolve) => {
        try {
          const tx = db.transaction("sounds", "readonly");
          const store = tx.objectStore("sounds");
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => resolve(null);
        } catch (err) {
          resolve(null);
        }
      });
    }
    function getAllDBEntries() {
      return new Promise((resolve, reject) => {
        try {
          const tx = db.transaction("sounds", "readonly");
          const store = tx.objectStore("sounds");
          const req = store.openCursor();
          const all = {};
          req.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
              all[cursor.key] = cursor.value;
              cursor.continue();
            } else {
              resolve(all);
            }
          };
          req.onerror = () => resolve(all);
        } catch (err) {
          resolve({});
        }
      });
    }

    // ---------- localStorageãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿èª­ã¿æ›¸ãï¼ˆãƒšãƒ¼ã‚¸æ•°ç„¡åˆ¶é™ï¼‰ ----------
    function pageKey(page) { return `soundData_page${page}`; }

    function loadPageData(page){
      try {
        const raw = localStorage.getItem(pageKey(page));
        if(!raw) {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ12å€‹ï¼ˆå¾“æ¥ä»•æ§˜ï¼‰
          return Array.from({length:12},()=>({label:'åŠ¹æœéŸ³',data:'',color:'#ffccdd',volume:1}));
        }
        return JSON.parse(raw);
      } catch(e) {
        console.error(e);
        return Array.from({length:12},()=>({label:'åŠ¹æœéŸ³',data:'',color:'#ffccdd',volume:1}));
      }
    }
    function savePageData(page,data){ localStorage.setItem(pageKey(page), JSON.stringify(data)); }

    // ---------- DOM è¦ç´  ----------
    const buttonGrid=document.getElementById('buttonGrid');
    const editToggleBtn=document.getElementById('editToggleBtn');
    const editPanel=document.getElementById('editPanel');
    const controlGroup=document.getElementById('controlGroup');
    const closeControls=document.getElementById('closeControls');
    const addButton=document.getElementById('addButton');
    const saveButton=document.getElementById('saveButton');
    const resetButton=document.getElementById('resetButton');
    const backupButton=document.getElementById('backupButton');
    const restoreButton=document.getElementById('restoreButton');
    const repostButton=document.getElementById('repostButton');
    const editLabel=document.getElementById('editLabel');
    const editColor=document.getElementById('editColor');
    const editFile=document.getElementById('editFile');
    const editVolume=document.getElementById('editVolume');
    const volUp=document.getElementById('volUp');
    const volDown=document.getElementById('volDown');
    const noSelectionMsg=document.getElementById('noSelectionMsg');
    const sizeSlider=document.getElementById('sizeSlider');
    const prevPageBtn=document.getElementById('prevPage');
    const nextPageBtn=document.getElementById('nextPage');
    const pageIndicator=document.getElementById('pageIndicator');

    let isEditMode=false;
    let selectedIndex=null;

    // ---------- å†ç”Ÿï¼ˆIndexedDB ã‹ã‚‰å–å¾—ï¼‰ ----------
    async function playSound(index){
      const item=soundData[index];
      if(!item.data){ alert('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

      // item.data ã¯ DB ã®ã‚­ãƒ¼
      await dbReadyPromise;
      const file = await getFromDB(item.data);
      if(!file){ alert('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }

      const url = URL.createObjectURL(file);
      const audio=new Audio(url);
      audio.volume=item.volume||1;
      audio.play();
      // URL.revokeObjectURL ã‚’ audio çµ‚äº†å¾Œã«ã™ã‚‹ã®ãŒãƒ™ã‚¿ãƒ¼ã ãŒã€ç°¡æ½”ã®ãŸã‚çœç•¥
    }

    // ---------- UI: ãƒœã‚¿ãƒ³æç”» ----------
    function renderButtons(){
      buttonGrid.innerHTML='';
      soundData.forEach((item,index)=>{
        const wrap=document.createElement('div');
        wrap.className='btn-wrap';
        const btn=document.createElement('button');
        btn.className='sound-button';
        btn.textContent=item.label||'åŠ¹æœéŸ³\n(å‰²ã‚Šå½“ã¦)';
        btn.style.backgroundColor=item.color;

        btn.onclick=()=>{
          playSound(index);
          if(isEditMode) selectButton(index);
        };

        const del=document.createElement('button');
        del.className='remove-btn';
        del.textContent='âœ–';
        del.onclick=(e)=>{
          e.stopPropagation();
          if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
            // å‰Šé™¤ï¼šé…åˆ—ã‹ã‚‰å‰Šé™¤ã—ã¦ä¿å­˜ï¼ˆDBå†…ã®éŸ³ã¯æ®‹ã™ or å–ã‚Šé™¤ãã‹ã¯é¸æŠï¼‰
            soundData.splice(index,1);
            savePageData(currentPage,soundData);
            clearSelection();
            renderButtons();
          }
        };
        del.style.display=isEditMode?'inline-block':'none';

        wrap.append(btn,del);
        buttonGrid.append(wrap);
      });
      buttonGrid.style.transform=`scale(${buttonScale/100})`;
      pageIndicator.textContent=currentPage;
      prevPageBtn.disabled=currentPage===1;
      // nextPageBtn ã¯å¸¸ã«æœ‰åŠ¹ï¼ˆãƒšãƒ¼ã‚¸ã¯è‡ªå‹•ä½œæˆå¯èƒ½ï¼‰
    }

    // ---------- é¸æŠ / ç·¨é›†çŠ¶æ…‹ ----------
    function selectButton(i){
      selectedIndex=i;
      const item=soundData[i];
      editLabel.value=item.label;
      editColor.value=item.color;
      editVolume.value=item.volume;
      [editLabel,editColor,editFile,editVolume,volUp,volDown].forEach(e=>e.disabled=false);
      noSelectionMsg.style.display='none';
    }
    function clearSelection(){
      selectedIndex=null;
      noSelectionMsg.style.display='block';
      [editLabel,editColor,editFile,editVolume,volUp,volDown].forEach(e=>e.disabled=true);
    }

    // ---------- å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ ----------
    editLabel.oninput=()=>{if(selectedIndex!=null){soundData[selectedIndex].label=editLabel.value;savePageData(currentPage,soundData);renderButtons();}};
    editColor.oninput=()=>{if(selectedIndex!=null){soundData[selectedIndex].color=editColor.value;savePageData(currentPage,soundData);renderButtons();}};
    editVolume.oninput=()=>{if(selectedIndex!=null){soundData[selectedIndex].volume=parseFloat(editVolume.value);savePageData(currentPage,soundData);}};
    volUp.onclick=()=>{if(selectedIndex!=null){editVolume.value=Math.min(1,parseFloat(editVolume.value)+0.05);editVolume.oninput();}};
    volDown.onclick=()=>{if(selectedIndex!=null){editVolume.value=Math.max(0,parseFloat(editVolume.value)-0.05);editVolume.oninput();}};

    // ---------- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼šIndexedDB ã«ä¿å­˜ã™ã‚‹ï¼ˆDataURLã¯ä¿å­˜ã—ãªã„ï¼‰ ----------
    editFile.onchange = async () => {
      if (selectedIndex != null && editFile.files[0]) {
        await dbReadyPromise;
        const file = editFile.files[0];
        // DBã‚­ãƒ¼ã¯ pageX_btnY å½¢å¼
        const id = `page${currentPage}_btn${selectedIndex}`;
        try {
          await putToDB(id, file);
          soundData[selectedIndex].data = id; // DB ã®ã‚­ãƒ¼ã ã‘ã‚’ä¿å­˜
          savePageData(currentPage, soundData);
          alert("éŸ³å£°ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
          renderButtons();
        } catch (err) {
          console.error(err);
          alert("éŸ³å£°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }
    };

    // ---------- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡æ›¿ ----------
    editToggleBtn.onclick=()=>{
      isEditMode=!isEditMode;
      editPanel.style.display=isEditMode?'block':'none';
      controlGroup.style.display=isEditMode?'flex':'none';
      editToggleBtn.style.display=isEditMode?'none':'block';
      if(!isEditMode)clearSelection();
      renderButtons();
    };

    closeControls.onclick=()=>{
      isEditMode=false;
      editPanel.style.display='none';
      controlGroup.style.display='none';
      editToggleBtn.style.display='block';
      clearSelection();
      renderButtons();
    };

    addButton.onclick=()=>{
      soundData.push({label:'',data:'',color:'#ffccdd',volume:1});
      savePageData(currentPage,soundData);
      renderButtons();
    };
    sizeSlider.oninput=()=>{buttonScale=parseInt(sizeSlider.value);localStorage.setItem('buttonScale',buttonScale);renderButtons();};
    saveButton.onclick=()=>{savePageData(currentPage,soundData);alert('ä¿å­˜ã—ã¾ã—ãŸï¼');};

    resetButton.onclick=()=>{
      if(confirm(`${currentPage}ãƒšãƒ¼ã‚¸ç›®ã ã‘åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ`)){
        localStorage.removeItem(pageKey(currentPage));
        soundData=loadPageData(currentPage);
        savePageData(currentPage,soundData);
        clearSelection();
        renderButtons();
        alert(`${currentPage}ãƒšãƒ¼ã‚¸ç›®ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸï¼`);
      }
    };

    repostButton.onclick=()=>{window.open("https://x.com/ari_sakura_x/status/1981206157789430051?s=61&t=bCZeaav0J1tJp_6k415_yQ","_blank");};

    // ---------- ãƒšãƒ¼ã‚¸ç§»å‹•ï¼ˆç„¡åˆ¶é™ï¼‰ ----------
    prevPageBtn.onclick=()=>{
      if(currentPage>1){
        currentPage--;
        localStorage.setItem('currentPage',currentPage);
        soundData=loadPageData(currentPage);
        clearSelection();
        renderButtons();
      }
    };
    nextPageBtn.onclick=()=>{
      currentPage++;
      localStorage.setItem('currentPage',currentPage);
      // æ–°ã—ã„ãƒšãƒ¼ã‚¸ãŒãªã‘ã‚Œã° loadPageData ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¿”ã™
      soundData=loadPageData(currentPage);
      clearSelection();
      renderButtons();
    };

    // ---------- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆlocalStorage + IndexedDB ã®éŸ³å£°ã‚’ DataURL ã«å¤‰æ›ã—ã¦ JSON å‡ºåŠ›ï¼‰ ----------
    async function blobToDataURL(blob) {
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = () => rej();
        r.readAsDataURL(blob);
      });
    }

    backupButton.onclick = async () => {
      await dbReadyPromise;
      try {
        // å…¨ãƒšãƒ¼ã‚¸ã‚­ãƒ¼ã‚’åé›†ï¼ˆsoundData_page*ï¼‰
        const backup = {};
        // save localStorage raw (other keys like currentPage/buttonScale included)
        // We'll include all soundData_page* entries
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key) continue;
          if (key.startsWith('soundData_page')) {
            try {
              const arr = JSON.parse(localStorage.getItem(key));
              // clone and replace data ids with dataURL blobs
              const clone = JSON.parse(JSON.stringify(arr));
              for (let j = 0; j < clone.length; j++) {
                const d = clone[j].data;
                if (typeof d === 'string' && d.startsWith('page')) {
                  const blob = await getFromDB(d);
                  if (blob) {
                    try {
                      const dataUrl = await blobToDataURL(blob);
                      clone[j].data = dataUrl; // embed actual audio data
                    } catch (e) {
                      clone[j].data = ''; // fallback
                    }
                  } else {
                    clone[j].data = ''; // DB missing
                  }
                }
              }
              backup[key] = clone;
            } catch (e) {
              backup[key] = localStorage.getItem(key);
            }
          } else if (key === 'buttonScale' || key === 'currentPage') {
            backup[key] = localStorage.getItem(key);
          }
        }

        // Also include any remaining DB entries that are not referenced (optional)
        // We'll not include separately to avoid duplication.

        const blob = new Blob([JSON.stringify(backup,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "soundTool_backup.json";
        a.click();
        URL.revokeObjectURL(url);
        alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸï¼");
      } catch (err) {
        console.error(err);
        alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    };

    // ---------- å¾©å…ƒï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿ã€éŸ³å£°ã¯ IndexedDB ã«ä¿å­˜ã—ã¦ localStorage ã‚’å¾©å…ƒï¼‰ ----------
    restoreButton.onclick = async () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const data = JSON.parse(reader.result);
            await dbReadyPromise;
            // For each soundData_page key provided
            for (const key of Object.keys(data)) {
              if (key.startsWith('soundData_page')) {
                const arr = data[key];
                // For each item, if data is dataURL, convert to blob and save into DB with standardized ID
                for (let i=0;i<arr.length;i++){
                  const item = arr[i];
                  if (item && typeof item.data === 'string' && item.data.startsWith('data:')) {
                    // convert to blob
                    const res = await fetch(item.data);
                    const blob = await res.blob();
                    const pageNum = parseInt(key.replace('soundData_page','')) || 1;
                    const id = `page${pageNum}_btn${i}`;
                    try {
                      await putToDB(id, blob);
                      item.data = id; // store DB key in item
                    } catch (err) {
                      console.error("DB put failed", err);
                      item.data = ''; // fallback
                    }
                  }
                }
                // Save page to localStorage (stringify)
                localStorage.setItem(key, JSON.stringify(arr));
              } else if (key === 'buttonScale' || key === 'currentPage') {
                localStorage.setItem(key, data[key]);
              } else {
                // ignore other keys
              }
            }
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
          } catch (err) {
            console.error(err);
            alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    // ---------- åˆæœŸæç”» ----------
    function initializeUI() {
      // ensure current page exists in storage (no-op if exists)
      if (!localStorage.getItem(pageKey(currentPage))) {
        savePageData(currentPage, loadPageData(currentPage));
      }
      sizeSlider.value = buttonScale;
      renderButtons();
    }

    // Wait DB ready but don't block UI
    dbReadyPromise.then(()=>{ initializeUI(); });

    // If DB never ready, still initialize after short delay
    setTimeout(()=>{ if(!db) initializeUI(); }, 500);

  </script>

  <h5>å³ä¸Šç·¨é›† â†’ ãƒœã‚¿ãƒ³é¸æŠ â†’ ç”»é¢ä¸‹è¨­å®šå¤‰æ›´ â†’ ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</h5>
</body>
</html>

